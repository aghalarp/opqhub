@*
This file is part of opq-ao.

opq-ao is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

opq-ao is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with opq-ao. If not, see <http://www.gnu.org/licenses/>.

Copyright 2013 Anthony Christe
*@

@(event: Event, rawPowerData: String)

@import helper._
  @implicitFieldConstructor = @{
    FieldConstructor(twitterBootstrapInput.render)
  }

@import play.api.libs.json.Json

@privatepowerqualitymonitoring("Private Power Quality Monitoring - Private Events",
  "This page allows you to manage and create power quality events.") {
  <div class="span9">
    <table class="table table-striped table-bordered">
      <thead>
        <tr>
          <th>Device Id</th>
          <th>Device Key</th>
          <th>Description</th>
          <th>Event Type</th>
          <th>Timestamp</th>
          <th>Duration (ms)</th>
          <th>Frequency (Hz)</th>
          <th>Voltage (V)</th>
          <th>Raw Waveform</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>@event.getAccessKey.getDeviceId</td>
          <td>@event.getAccessKey.getAccessKey</td>
          <td>@event.getAccessKey.getOpqDevice.getDescription</td>
          <td>@event.getEventType.getName</td>
          <td>@utils.DateUtils.toDateTime(event.getTimestamp)</td>
          <td>@event.getDuration</td>
          <td>@event.getFrequency</td>
          <td>@event.getVoltage</td>
          <td><a href="@routes.Events.rawPowerData(event.getPrimaryKey)" class="btn btn-warning">Raw Data</a></td>
        </tr>
      </tbody>
    </table>
  </div>
  @* TODO: Re-enable charts *@

  <!-- ITIC Curve - Should only be displayed on voltage events -->
  @if(event.getEventType.equals(org.openpowerquality.protocol.OpqPacket.PacketType.EVENT_VOLTAGE)) {
    <div class="row">
      <div id="itic-plot" class="span9" style="height:300px; width:500px;"></div>
      <div class="span9" id="plotter" style="height:300px; width:500px"></div>
    </div>
  }

  <!-- Raw RMS voltage -->
  <div class="row">



  </div>


  <script src="@routes.Assets.at("javascripts/flot/jquery.flot.js")" type="text/javascript"></script>
  <script src="@routes.Assets.at("javascripts/flot/jquery.flot.navigate.js")" type="text/javascript"></script>
  <script src="@routes.Assets.at("javascripts/flot/jquery.flot.axislabels.js")" type="text/javascript"></script>
  <script src="@routes.Assets.at("javascripts/itic-plotter.js")" type="text/javascript"></script>
  <script type="text/javascript">

    console.log("Before t");
   var t = @Html(Json.obj(
              "data" -> rawPowerData
            ).toString());
    var data = t.data.substring(0, t.data.length - 1);
    console.log(data);
    var splitData = data.split(",");
    var points = [[]];
  var rmsStandard = 169.7;

    var max = Math.max.apply(null, splitData);
    var min = Math.min.apply(null, splitData);
    for(var i = 0; i < splitData.length; i++) {
        points[0].push([i, splitData[i]]);
    }

    //var standardLinePositive = [[0, rmsStandard], [points[0].length, rmsStandard]];

    points[0].push(null);
    points[0].push([0, rmsStandard]);
    points[0].push([points[0].length - 2, rmsStandard]);
    points[0].push(null);
    points[0].push([0, -rmsStandard]);
    points[0].push([points[0].length - 4, -rmsStandard]);
    points[0].push(null);

    var plotOptions = {
      min: min - 20,
      max: max + 20,
      zoom: {
        interactive: true
      },
      pan: {
        interactive: true
      },
      acisLabels: {
        show: true
      },
      xaxes: [{
        axisLabel: "Samples"
      }],
      yaxes: [{
        axisLabel: "Voltage"
      }],
      series: {
        lines: { show: true },
        points: { show: false }
      }
    };

    $.plot($("#plotter"), points, plotOptions);


    @if(event.getEventType.equals(org.openpowerquality.protocol.OpqPacket.PacketType.EVENT_VOLTAGE)) {
      var p = iticPlotter;
      p.init("#itic-plot");
      p.addPoint(@event.getDuration, p.voltageToPercentNominalVoltage(@event.getVoltage));

      $("<div id='tooltip'></div>").css({
        position: "absolute",
        display: "none",
        border: "1px solid #fdd",
        padding: "2px",
        "background-color": "#fee",
        opacity: 0.80
      }).appendTo("body");

      $("#itic-plot").bind("plothover", function (event, pos, item) {
        if (item) {
          var duration = item.datapoint[0].toFixed(2);
          var percentNominalVoltage = item.datapoint[1].toFixed(2);

          $("#tooltip").html(p.formatTooltip([["Duration (ms)", duration],
                                              ["Duration (c)", p.msToC(duration).toFixed(2)],
                                              ["% nominal voltage", percentNominalVoltage],
                                              ["Volts", p.percentNominalVoltageToVoltage(percentNominalVoltage)],
                                              ["ITIC Region", item.series.label]]))
            .css({top: item.pageY+5, left: item.pageX+5})
            .fadeIn(200);
        } else {
          $("#tooltip").hide();
        }
      });
      p.update();
    }

  </script>
}
