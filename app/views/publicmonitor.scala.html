@(data: template.data.PublicMonitorData)
<!DOCTYPE html>
<html>
    <head lang="en">
        <meta charset="UTF-8">
        <title>OPQHub - Public Power Quality</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

            <!-- Needed libraries -->
        <script src="@routes.Assets.at("contrib/js/jquery-2.1.1.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("contrib/js/moment.min.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("contrib/js/bootstrap.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("contrib/js/bootstrap-datetimepicker.min.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("contrib/js/bootstrap-datetimepicker.min.js")" type="text/javascript"></script>

        <script src="@routes.Assets.at("contrib/js/leaflet.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("contrib/js/jquery.flot.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("contrib/js/jquery.flot.navigate.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("contrib/js/spin.min.js")" type="text/javascript"></script>

        <link rel="stylesheet" media="screen" href="@routes.Assets.at("contrib/css/bootstrap.css")">
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("contrib/css/bootstrap-datetimepicker.css")">
        <link rel="stylesheet" media="screen" href="@routes.Assets.at("contrib/css/leaflet.css")">

            <!-- Site specific details -->
        <script src="@routes.Assets.at("js/grid-map.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("js/itic-plotter.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("js/public-map.js")" type="text/javascript"></script>
        <script src="@routes.Assets.at("js/public-filters.js")" type="text/javascript"></script>

        <link rel="stylesheet" media="screen" href="@routes.Assets.at("css/site.css")">

            <!-- Validation -->
        <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.13.0/jquery.validate.min.js"></script>
        <script type="text/javascript" src="http://ajax.aspnetcdn.com/ajax/jquery.validate/1.13.0/additional-methods.min.js"></script>



    </head>
    <body>
            <!-- Responsive navbar -->
        @navbar()

            <!-- Main content -->
        <div class="container" id="main-content">

                <!-- Main two columns. Left: controls & map. Right: Events and event details. -->
            <div class="row">

                    <!-- Controls and map -->
                <div class="col-md-5">

                        <!-- Controls -->
                    <div class="row">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">Display</h3>
                            </div>
                            <div class="panel-body">

                                    <!-- Frequency filter -->
                                <div class="row">
                                    <label class="col-sm-3">Freq. (Hz)</label>
                                    <div class="col-xs-1">
                                        <input type="checkbox" class="checkbox" id="requestFrequency" @if(data.requestFrequency){checked="checked"}>
                                    </div>
                                    <div class="form-group col-sm-4">
                                        <label class="sr-only" for="frequencyGt">Frequency Greater Than</label>
                                        <input type="text" class="form-control" id="frequencyGt"
                                            value="@utils.DisplayUtils.twoDecimal.format(data.minFrequency)">
                                    </div>
                                    <div class="form-group col-sm-4">
                                        <label class="sr-only" for="frequencyLt">Frequency Less Than</label>
                                        <input type="text" class="form-control" id="frequencyLt"
                                            value="@utils.DisplayUtils.twoDecimal.format(data.maxFrequency)">
                                    </div>
                                </div>

                                    <!-- Voltage filter -->
                                <div class="row">
                                    <label class="col-sm-3">Voltage (V)</label>
                                    <div class="col-xs-1">
                                        <input type="checkbox" id="requestVoltage" @if(data.requestVoltage){checked="checked"}>
                                    </div>
                                    <div class="form-group col-sm-4">
                                        <label class="sr-only" for="voltageGt">Voltage Greater Than</label>
                                        <input type="text" class="form-control" id="voltageGt"
                                            value="@utils.DisplayUtils.oneDecimal.format(data.minVoltage)">
                                    </div>
                                    <div class="form-group col-sm-4">
                                        <label class="sr-only" for="voltageLt">Voltage Less Than</label>
                                        <input type="text" class="form-control" id="voltageLt"
                                            value="@utils.DisplayUtils.oneDecimal.format(data.maxVoltage)">
                                    </div>
                                </div>

                                    <!-- Duration filter -->
                                <div class="row">
                                    <label class="col-sm-4">Duration (sec)</label>
                                    <div class="form-group col-sm-4">
                                        <label class="sr-only" for="durationGt">Duration Greater Than</label>
                                        <input type="text" class="form-control" id="durationGt" value="@data.minDuration">
                                    </div>
                                    <div class="form-group col-sm-4">
                                        <label class="sr-only" for="durationLt">Duration Less Than</label>
                                        <input type="text" class="form-control" id="durationLt" value="@data.maxDuration">
                                    </div>
                                </div>

                                    <!-- ITIC filter -->
                                <div class="row">
                                    <label class="col-sm-4 control-label">ITIC</label>
                                    <label class="col-xs-2 control-label">Severe</label>
                                    <div class="col-xs-1">
                                        <input type="checkbox" id="requestIticSevere" @if(data.iticSevere){checked="checked"}>
                                    </div>
                                    <label class="col-xs-2 control-label">Moderate</label>
                                    <div class="col-xs-1">
                                        <input type="checkbox" id="requestIticModerate" @if(data.iticModerate){checked="checked"}>
                                    </div>
                                    <label class="col-xs-1 control-label">OK</label>
                                    <div class="col-xs-1">
                                        <input type="checkbox" id="requestIticOk" @if(data.iticOk){checked="checked"}>
                                    </div>
                                </div>


                                    <!-- Time interval filter -->
                                <div class="row">
                                    <div class="form-group">

                                            <!-- Start time interval -->
                                        <label for="startTimestamp" class="col-sm-2 control-label">Time Interval</label>
                                        <div class="col-sm-5">
                                            <div class='input-group date' id='startTimestamp'>
                                                <input type='text' class="form-control" id="startTimestampInput"/>
                                                <span class="input-group-addon">
                                                    <span class="glyphicon glyphicon-calendar"></span>
                                                </span>
                                            </div>
                                        </div>

                                            <!-- Stop time interval -->
                                        <div class="col-sm-5">
                                            <div class='input-group date' id='stopTimestamp'>
                                                <input type='text' class="form-control" id="stopTimestampInput"/>
                                                <span class="input-group-addon">
                                                    <span class="glyphicon glyphicon-calendar"></span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                    <div id="error" class="verror"></div>
                                </div>

                                    <!-- Update/Reset buttons -->
                                <div class="row">
                                    <label class="col-sm-2">Actions</label>
                                    <div class="col-sm-8">
                                        <button type="button" class="btn btn-primary btn-xs updateBtn" id="updateBtn">Update</button>
                                    </div>
                                </div>
                            </div>
                            <div id="messages" class="invalid"></div>
                        </div>
                    </div>

                        <!-- Map -->
                    <div class="row public-map">
                        <div class="public-map" id="public-map"></div>
                    </div>
                </div>

                    <!-- Events and event details -->
                <div class="col-md-7" id="public-map-right-col">

                        <!-- Events -->
                    <div class="row">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title" id="events-title">Events</h3>
                                <table>
                                    <tr>
                                        <td>Total Events</td> <td><span id="totalEvents" class='badge global-stats'>@data.totalEventsCount</span></td>
                                        <td>Frequency Events</td> <td><span id="totalFrequencyEvents" class='badge global-stats'>@data.frequencyEventsCount</span></td>
                                        <td>Voltage Events</td> <td><span id="totalVoltageEvents" class='badge global-stats'>@data.voltageEventsCount</span></td>
                                    </tr>
                                </table>
                            </div>
                            <div class="panel-body" id="events-table">
                                @if(data.totalEventsCount > 0) {
                                <table class="table table-hover" id="events">
                                    <thead>
                                        <tr>
                                            <th>Timestamp</th>
                                            <th>Type</th>
                                            <th>Duration</th>
                                            <th>Value</th>
                                            <th>ITIC</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @for(event <- data.totalEvents) {
                                            <tr id="@event.getPrimaryKey">
                                                <td>@utils.DateUtils.toDateTime(event.getTimestamp)</td>
                                                <td>@event.getEventType.getName</td>
                                                <td>@event.getDuration s</td>
                                                <td>
                                                    @if(event.getEventType.getName.equals("Voltage Event")){
                                                        @utils.DisplayUtils.oneDecimal.format(event.getVoltage) V
                                                    }
                                                    @if(event.getEventType.getName.equals("Frequency Event")){
                                                        @utils.DisplayUtils.twoDecimal.format(event.getFrequency) Hz
                                                    }
                                                </td>
                                                <td>
                                                    @{utils.PqUtils.getIticRegion(event.getDuration * 1000, event.getVoltage) match {
                                                        case utils.PqUtils.IticRegion.NO_INTERRUPTION => <span class='badge itic-badge itic-no-interruption'>&nbsp;</span>
                                                        case utils.PqUtils.IticRegion.NO_DAMAGE => <span class='badge itic-badge itic-no-damage'>&nbsp;</span>
                                                        case utils.PqUtils.IticRegion.PROHIBITED => <span class='badge itic-badge itic-prohibited'>&nbsp;</span>
                                                        case _ => "N/A"
                                                    }}
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                                } else {
                                    No events to display.
                                }
                            </div>
                            <div class="panel-footer panel-title">
                                 @if(data.page > 0) {
                                     <button type="button" class="btn btn-primary btn-xs" id="prev-page-btn">
                                         <span class="glyphicon glyphicon-arrow-left" aria-hidden="true"></span>
                                     </button>
                                 }
                                 @{data.page + 1} / @{data.totalPages + 1}
                                 @if(data.page < data.totalPages) {
                                    <button type="button" class="btn btn-primary btn-xs" id="next-page-btn">
                                        <span class="glyphicon glyphicon-arrow-right" aria-hidden="true"></span>
                                    </button>
                                 }
                            </div>
                        </div>
                    </div>

                        <!-- Event details -->
                    <div class="row">
                            <!-- Hidden fields that allow us to store the location of each event -->
                        <input type="hidden" id="details-center-lat" />
                        <input type="hidden" id="details-center-lng" />
                        <input type="hidden" id="details-zoom" />

                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 id="event-title" class="panel-title">Event Details</h3>
                            </div>
                            <div class="panel-body">
                                <div class="col-md-4">
                                    @if(data.detailedEvent.ne(null)) {
                                        <table class="table table-condensed">
                                            <tbody>
                                                <tr>
                                                    <td>Frequency</td>
                                                    <td id="details-frequency">
                                                        @utils.DisplayUtils.twoDecimal.format(data.detailedEvent.getFrequency)
                                                        Hz
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Voltage</td>
                                                    <td id="details-voltage">
                                                        @utils.DisplayUtils.oneDecimal.format(data.detailedEvent.getVoltage)
                                                        V
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Duration</td>
                                                    <td id="details-duration">
                                                        @data.detailedEvent.getDuration s
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td id="details-itic-title">ITIC</td>
                                                    <td id="details-itic-severity">
                                                    @{
                                                        utils.PqUtils.getIticRegion(data.detailedEvent.getDuration * 1000, data.detailedEvent.getVoltage) match {
                                                            case utils.PqUtils.IticRegion.NO_INTERRUPTION => <span class='badge itic-badge itic-no-interruption'>&nbsp;</span>
                                                            case utils.PqUtils.IticRegion.NO_DAMAGE => <span class='badge itic-badge itic-no-damage'>&nbsp;</span>
                                                            case utils.PqUtils.IticRegion.PROHIBITED => <span class='badge itic-badge itic-prohibited'>&nbsp;</span>
                                                            case _ => "N/A"
                                                        }
                                                    }
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <td>Location</td>
                                                    <td>
                                                        <a class="btn-link" id="details-grid-id">
                                                        @data.detailedEvent.getLocation.getGridId
                                                        </a>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    } else {
                                        No event details to display.
                                    }
                                </div>
                                <div id="waveform" class="col-md-4 plot"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script type="text/javascript">
            /*
             * Grabs all of the needed parameters from the filters, pagination, and the map, and then constructs
             * a new url to update the page.
             */
            function update(page, detailedEventId) {
                var visibleIds = grid.getVisibleIds( ).join(";");
                visibleIds = visibleIds.split("," ).join("c");
                visibleIds = visibleIds.split(":" ).join("C");
                visibleIds = visibleIds.split(";" ).join("s");

                var params = {
                    requestFrequency: $ ( "#requestFrequency" ).is ( ':checked' ),
                    minFrequency    : $ ( "#frequencyGt" ).val ( ),
                    maxFrequency    : $ ( "#frequencyLt" ).val ( ),
                    requestVoltage  : $ ( "#requestVoltage" ).is ( ':checked' ),
                    minVoltage      : $ ( "#voltageGt" ).val ( ),
                    maxVoltage      : $ ( "#voltageLt" ).val ( ),
                    minDuration     : $ ( "#durationGt" ).val ( ),
                    maxDuration     : $ ( "#durationLt" ).val ( ),
                    minTimestamp    : moment.utc ( $ ( "#startTimestamp" ).data ( "DateTimePicker" ).getDate ( ) )._d.getTime ( ),
                    maxTimestamp    : moment.utc ( $ ( "#stopTimestamp" ).data ( "DateTimePicker" ).getDate ( ) )._d.getTime ( ),
                    iticSevere      : $ ( "#requestIticSevere" ).is ( ':checked' ),
                    iticModerate    : $ ( "#requestIticModerate" ).is ( ':checked' ),
                    iticOk          : $ ( "#requestIticOk" ).is ( ':checked' ),
                    mapCenterLat    : grid.getCenterLat ( ),
                    mapCenterLng    : grid.getCenterLng ( ),
                    mapZoom         : grid.getZoom ( ),
                    page            : page || 0,
                    detailedEventId : detailedEventId || -1,
                    mapVisibleIds   : visibleIds
                };

                var url = window.location.pathname + "?" + $.param(params);
                window.location.href = url;
            }

            /* ---------- Intialize the page components ----------*/
            // Set up calendar fields correctly
            $("#startTimestamp" ).datetimepicker();
            $("#stopTimestamp" ).datetimepicker();
            $("#startTimestamp").data("DateTimePicker").setDate(new Date(@data.minTimestamp));
            $("#stopTimestamp").data("DateTimePicker").setDate(new Date(@data.maxTimestamp));

            // Initialize the map
            grid.initMap("public-map", [@data.mapCenterLat, @data.mapCenterLng], @data.mapZoom);

            // Set up plot for event details
            var plotOptions = {

                zoom: {
                    interactive: true
                },
                pan: {
                    interactive: true
                },
                acisLabels: {
                    show: true
                },
                xaxis: {
                    ticks: 5,
                    min: 1000,
                    max: 3000
                },
                xaxes: [{
                    axisLabel: "Samples"
                }],
                yaxes: [{
                    axisLabel: "Voltage"
                }],
                series: {
                    lines: {show: true},
                    points: {show: false}
                }
            };

            var plotPoints = "@data.detailedEvent.getEventData.getWaveform"
                .split(",").map(function(pt, idx) {
                    return [idx, parseFloat(pt)];
                });
            $.plot($("#waveform"), [plotPoints], plotOptions)
            console.log(plotPoints);

            /* ---------- Handle click events ---------- */
            // When update button is clicked, generate URL and goto
            $("#updateBtn").click(function() {
                update();
            });

            // Next and previous page buttons
            $("#prev-page-btn").click(function() {
                update(@{data.page - 1});
            });

            $("#next-page-btn").click(function() {
                update(@{data.page + 1});
            });

            // Table row details update
            $("#events tr" ).click(function(){
               update(@data.page, this.id);
            });
        </script>
    </body>
</html>
